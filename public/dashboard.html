<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>MC Bot Manager Pro</title>
    <link rel="stylesheet" href="css/style_dashboard.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

    <nav class="sidebar">
        <div class="logo">MC MANAGER</div>
        <div class="menu-item active" onclick="showSection('dashboard')">üìä Dashboard</div>
        <div class="menu-item" onclick="showSection('accounts')">‚ûï Accounts</div>
        <div class="menu-item" onclick="showSection('accessibility')">üéÆ Accessibility</div>
        <div class="menu-item" onclick="showSection('settings')">‚öôÔ∏è Settings</div>
        <div style="margin-top: auto; padding: 15px;">
            <a href="/logout" style="color: var(--danger); text-decoration: none;">üö™ Logout</a>
        </div>
    </nav>

    <main class="main-content">
        
        <div id="dashboard" class="section active">
            <h2>Panou de Control</h2>
            <div class="stats-grid">
                <div class="card">
                    <h3>Conturi Totale</h3>
                    <h1 id="total-bots">0</h1>
                </div>
                <div class="card">
                    <h3>Bo»õi Online</h3>
                    <h1 id="online-bots" style="color: var(--neon-green)">0</h1>
                </div>
            </div>
        </div>

        <div id="accounts" class="section">
            <h2>AdaugƒÉ Bot Nou</h2>
            <div class="card" style="max-width: 500px;">
                <form id="add-bot-form">
                    <label>Nickname</label>
                    <input type="text" name="nickname" required placeholder="Ex: SteveBot01">
                    
                    <label>Server IP</label>
                    <input type="text" name="server_ip" required placeholder="Ex: play.hypixel.net">
                    
                    <label>Versiune (Op»õional)</label>
                    <input type="text" name="version" placeholder="LasƒÉ gol pentru auto-detect">
                    
                    <label>Proxy (Op»õional)</label>
                    <input type="text" name="proxy" placeholder="ip:port">
                    
                    <label>Mesaj Automat (Join)</label>
                    <input type="text" name="auto_msg" placeholder="/login parola123">
                    
                    <button type="submit" class="btn">SalveazƒÉ Contul</button>
                </form>
            </div>
        </div>

        <div id="accessibility" class="section">
            <h2>Control Bo»õi</h2>
            <p>Click pe un card pentru a deschide consola.</p>
            <div id="bots-list" class="bot-grid">
                </div>
        </div>

        <div id="settings" class="section">
            <h2>SetƒÉri Aplica»õie</h2>
            <div class="card">
                <label>TemƒÉ Interfa»õƒÉ</label>
                <button class="btn" onclick="toggleTheme()">SchimbƒÉ Light/Dark Mode</button>
            </div>
        </div>
    </main>

    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between;">
                <h3 id="modal-bot-name">Bot Console</h3>
                <button onclick="closeModal()" style="background:none; border:none; color:red; cursor:pointer;">X</button>
            </div>
            <div id="chat-logs"></div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="cmd-input" placeholder="Scrie o comandƒÉ sau chat...">
                <button class="btn" onclick="sendCommand()">Trimite</button>
            </div>
            <div style="margin-top: 10px; display:flex; gap:10px;">
                <button class="btn" onclick="startBotCurrent()" style="background: var(--neon-green)">START</button>
                <button class="btn" onclick="stopBotCurrent()" style="background: var(--danger); color:white;">STOP</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentBotId = null; // Re»õine ID-ul botului selectat

        // --- 1. NAVIGARE UI ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function toggleTheme() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            body.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
        }

        // --- 2. GESTIONARE LISTA BO»öI ---
        async function loadBots() {
            try {
                const res = await fetch('/api/bots');
                const bots = await res.json();
                
                const list = document.getElementById('bots-list'); // Gridul de la Accessibility
                list.innerHTML = '';
                
                let onlineCount = 0;
                document.getElementById('total-bots').innerText = bots.length;

                bots.forEach(bot => {
                    if(bot.isOnline) onlineCount++;
                    
                    const div = document.createElement('div');
                    div.className = `bot-card ${bot.isOnline ? 'online' : ''}`;
                    div.innerHTML = `
                        <h3>${bot.nickname}</h3>
                        <p>${bot.server_ip}</p>
                        <span class="bot-status" style="color:${bot.isOnline ? 'var(--neon-green)' : 'gray'}">
                            ${bot.isOnline ? '‚óè ONLINE' : '‚óã OFFLINE'}
                        </span>
                        <div style="margin-top:10px; font-size:0.8rem; color:#888;">Click pentru ConsolƒÉ</div>
                    `;
                    // C√¢nd dai click pe cartona»ô, deschide consola acelui bot
                    div.onclick = () => openConsole(bot.id, bot.nickname);
                    list.appendChild(div);
                });
                
                document.getElementById('online-bots').innerText = onlineCount;
            } catch (err) {
                console.error("Eroare la √ÆncƒÉrcarea bo»õilor:", err);
            }
        }

        // --- 3. LOGICA DE CONSOLƒÇ »òI CHAT ---

        // Deschide fereastra (Modal)
        function openConsole(id, name) {
            currentBotId = id; // SetƒÉm botul activ
            document.getElementById('modal-bot-name').innerText = `ConsolƒÉ: ${name}`;
            document.getElementById('chat-logs').innerHTML = ''; // CurƒÉ»õƒÉm chatul vechi
            document.getElementById('chat-modal').style.display = 'flex';
            
            addLog("System", "Conectat la panoul de control al botului. A»ôtept mesaje...");
        }

        // √énchide fereastra
        function closeModal() {
            document.getElementById('chat-modal').style.display = 'none';
            currentBotId = null; // Nu mai ascultƒÉm chatul acestui bot
            loadBots(); // DƒÉm refresh la status
        }

        // --- 4. TRIMITERE »òI PRIMIRE MESAJE ---

        // Func»õie ajutƒÉtoare pentru a adƒÉuga text √Æn fereastra neagrƒÉ
        function addLog(user, msg) {
            const logs = document.getElementById('chat-logs');
            const p = document.createElement('div');
            p.className = 'log-line';
            
            // ColorƒÉm diferit mesajele tale vs ale altora
            if (user === 'Tu') {
                p.style.color = 'cyan';
                p.innerHTML = `> <b>${user}:</b> ${msg}`;
            } else if (user === 'System') {
                p.style.color = 'yellow';
                p.innerHTML = `<i>[SYS]: ${msg}</i>`;
            } else {
                p.innerHTML = `<span style="color: lime;">[${user}]</span>: ${msg}`;
            }

            logs.appendChild(p);
            // AUTO-SCROLL: Mereu jos
            logs.scrollTop = logs.scrollHeight;
        }

        // A. PRIMIRE MESAJE (De la Server -> Site)
        socket.on('bot-log', (data) => {
            // Afi»ôƒÉm mesajul doar dacƒÉ avem deschisƒÉ consola botului respectiv
            if (currentBotId && data.id === currentBotId) {
                // Backend-ul trimite formatul "msg: [Nume]: Mesaj" sau erori
                // Facem o curƒÉ»õare simplƒÉ
                let message = data.msg;
                let user = "Server";

                // √éncercƒÉm sƒÉ detectƒÉm cine a scris
                if (message.startsWith('[')) {
                    // DacƒÉ mesajul e de tipul "[Steve]: Salut"
                    // √él afi»ôƒÉm direct
                    const logs = document.getElementById('chat-logs');
                    const p = document.createElement('div');
                    p.className = 'log-line';
                    p.innerText = message; 
                    logs.appendChild(p);
                    logs.scrollTop = logs.scrollHeight;
                } else {
                    addLog("Info", message);
                }
            }
        });

        // B. TRIMITERE MESAJE (De la Site -> Server -> Minecraft)
        function sendCommand() {
            const input = document.getElementById('cmd-input');
            const command = input.value;
            
            if (currentBotId && command) {
                // Trimitem prin Socket cƒÉtre server.js
                socket.emit('send-command', { botId: currentBotId, command: command });
                
                // Afi»ôƒÉm ce am scris »ôi noi √Æn consolƒÉ
                addLog("Tu", command);
                input.value = ''; // Golim cƒÉsu»õa
            }
        }

        // Permite trimiterea cu tasta ENTER
        document.getElementById('cmd-input').addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendCommand();
            }
        });

        // --- 5. CONTROL START/STOP ---
        async function startBotCurrent() {
            if(!currentBotId) return;
            addLog("System", "Se ini»õiazƒÉ conectarea...");
            await fetch('/api/bots/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: currentBotId})
            });
        }

        async function stopBotCurrent() {
            if(!currentBotId) return;
            addLog("System", "Se trimite comanda de deconectare...");
            await fetch('/api/bots/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: currentBotId})
            });
        }

        // Socket listener pentru update-uri globale de status
        socket.on('bot-status', () => {
            loadBots(); 
        });

        // AdƒÉugare Bot Nou (Formular)
        document.getElementById('add-bot-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            await fetch('/api/bots', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            alert('Bot salvat!');
            e.target.reset();
            loadBots();
        });

        // Ini»õializare
        loadBots();
        setInterval(loadBots, 5000); // Refresh la lista de bo»õi la 5 secunde
    </script>
